<!DOCTYPE html>
<html>
    <head>
        <title>HTML5 Canvas Platformer</title>
        <style>
            body { background-color:#546e7a; font-family:sans-serif; }
            h1, h3 { color:#fff; text-align:center; line-height:.8em; }
            h1 small { font-weight:normal; font-size:66.66667%; }
            span.mono { font-weight:normal; font-family:monospace; }
            #canvas-container { text-align:center; }
            #canvas { border:1px solid #000; }
        </style>
    </head>
    <body>
    <h1>HTML5 Canvas Platformer<br/><small>(a work in progress)</small></h1>
    <h3>Move: <span class="mono">[<-] [->]</span></h3>
    <h3>Jump: <span class="mono">[SPACE]</span></h3>
    <div id="canvas-container">
        <canvas id="canvas"></canvas>
    </div>
    <script>
        var CANVAS_WIDTH = 768;
        var CANVAS_HEIGHT = 432;
        var DEFAULT_PLAYER_WIDTH = 16;
        var DEFAULT_PLAYER_HEIGHT = 16;
        var DEFAULT_PLAYER_SPEED = 4;
        var DEFAULT_PLAYER_FRICTION = 0.8;
        var DEFAULT_PLAYER_GRAVITY = 0.4;
        var DEFAULT_BOX_THICKNESS = 16;
    
        (function(){
            var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
            window.requestAnimationFrame = requestAnimationFrame;

            var canvas;
            var context;
            var player;
            var keys = [];
            var boxes = [];
            var gradient;
            
            window.addEventListener("load", function(){
                start();
            });
            
            document.body.addEventListener("keydown", function(e){
                keys[e.keyCode] = true;
            });
            
            document.body.addEventListener("keyup", function(e){
                keys[e.keyCode] = false;
            });
            
            function start(){
                canvas = document.getElementById("canvas");
                context = canvas.getContext("2d");
                canvas.width = CANVAS_WIDTH;
                canvas.height = CANVAS_HEIGHT;
                gradient = context.createLinearGradient(CANVAS_WIDTH / 2, 0, CANVAS_WIDTH / 2, CANVAS_HEIGHT);
                gradient.addColorStop(0, "#29b6f6");
                gradient.addColorStop(1, "#b3e5fc");

                player = {
                    x: 32,
                    y: CANVAS_HEIGHT * 0.75,
                    width: DEFAULT_PLAYER_WIDTH,
                    height: DEFAULT_PLAYER_HEIGHT,
                    speed: DEFAULT_PLAYER_SPEED,
                    velX: 0,
                    velY: 0,
                    friction: DEFAULT_PLAYER_FRICTION,
                    gravity: DEFAULT_PLAYER_GRAVITY,
                    jumping: false,
                    grounded: false,
                    color: "#e53935"
                };
                
                boxes.push({x:0, y:CANVAS_HEIGHT - DEFAULT_BOX_THICKNESS * 2, width:DEFAULT_BOX_THICKNESS * 17, height:DEFAULT_BOX_THICKNESS * 2, color:"#795548"});
                boxes.push({x:DEFAULT_BOX_THICKNESS * 23, y:CANVAS_HEIGHT - DEFAULT_BOX_THICKNESS * 2, width:DEFAULT_BOX_THICKNESS * 17, height:DEFAULT_BOX_THICKNESS * 2, color:"#795548"});

                boxes.push({x:0, y:CANVAS_HEIGHT - DEFAULT_BOX_THICKNESS * 3, width:DEFAULT_BOX_THICKNESS * 17, height:DEFAULT_BOX_THICKNESS, color:"#4caf50"});
                boxes.push({x:DEFAULT_BOX_THICKNESS * 23, y:CANVAS_HEIGHT - DEFAULT_BOX_THICKNESS * 3, width:DEFAULT_BOX_THICKNESS * 17, height:DEFAULT_BOX_THICKNESS, color:"#4caf50"});

                boxes.push({x:0, y:CANVAS_HEIGHT - DEFAULT_BOX_THICKNESS * 11 , width:DEFAULT_BOX_THICKNESS, height:DEFAULT_BOX_THICKNESS * 8, color:"#f57f17"});
                boxes.push({x:DEFAULT_BOX_THICKNESS * 4, y:CANVAS_HEIGHT - DEFAULT_BOX_THICKNESS * 7, width:DEFAULT_BOX_THICKNESS * 10, height:DEFAULT_BOX_THICKNESS, color:"#f57f17"});
                boxes.push({x:CANVAS_WIDTH - DEFAULT_BOX_THICKNESS * 4, y:CANVAS_HEIGHT - DEFAULT_BOX_THICKNESS * 7, width:DEFAULT_BOX_THICKNESS * 2, height:DEFAULT_BOX_THICKNESS, color:"#f57f17"});
                boxes.push({x:CANVAS_WIDTH - DEFAULT_BOX_THICKNESS * 10, y:CANVAS_HEIGHT - DEFAULT_BOX_THICKNESS * 11, width:DEFAULT_BOX_THICKNESS * 1, height:DEFAULT_BOX_THICKNESS, color:"#f57f17"});

                update();
            }
            
            function update(){
                if(keys[32] === true){
                    // space
                    if(!player.jumping && player.grounded){
                        player.jumping = true;
                        player.grounded = false;
                        player.velY = -player.speed * 2;
                    }
                }
                
                player.velX = 0;
                
                if(keys[39] === true){
                    // right arrow
                    if(player.velX < player.speed){
                        player.velX++;
                    }
                }
                
                if(keys[37] === true){
                    // left arrow
                    if(player.velX > -player.speed){
                        player.velX--;
                    }
                }

                player.velX *= (player.friction * player.speed);
                player.velY += player.gravity;
                
                context.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
                context.fillStyle = gradient;
                context.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
                
                player.grounded = false;
                for(var i = 0; i < boxes.length; i++) {
                    context.fillStyle = boxes[i].color;
                    context.fillRect(boxes[i].x, boxes[i].y, boxes[i].width, boxes[i].height);
                    var dir = colCheck(player, boxes[i]);
                    if(dir === "l" || dir === "r"){
                        player.velX = 0;
                        player.jumping = false;
                    } else if(dir === "b"){
                        player.grounded = true;
                        player.jumping = false;
                    } else if(dir === "t"){
                        player.velY *= -1;
                    }
                }
                
                if(player.grounded) {
                    player.velY = 0;
                }
                
                player.x += player.velX;
                player.y += player.velY;
                
                if(player.x >= CANVAS_WIDTH || player.x <= -player.width || player.y >= CANVAS_HEIGHT){
                    die();
                } else {
                    context.fillStyle = player.color;
                    context.fillRect(player.x, player.y, player.width, player.height);
                    
                    requestAnimationFrame(update);
                }
            }
            
            function die(){
                start();
            }

            function colCheck(shapeA, shapeB) {
                // get the vectors to check against
                var vX = (shapeA.x + (shapeA.width / 2)) - (shapeB.x + (shapeB.width / 2));
                var vY = (shapeA.y + (shapeA.height / 2)) - (shapeB.y + (shapeB.height / 2));
                    // add the half widths and half heights of the objects
                var hWidths = (shapeA.width / 2) + (shapeB.width / 2);
                var hHeights = (shapeA.height / 2) + (shapeB.height / 2);
                var colDir = null;
             
                // if the x and y vector are less than the half width or half height, they we must be inside the object, causing a collision
                if (Math.abs(vX) < hWidths && Math.abs(vY) < hHeights) {
                    // figures out on which side we are colliding (top, bottom, left, or right)
                    var oX = hWidths - Math.abs(vX);
                    var oY = hHeights - Math.abs(vY);
                    if (oX >= oY) {
                        if (vY > 0) {
                            colDir = "t";
                            shapeA.y += oY;
                        } else {
                            colDir = "b";
                            shapeA.y -= oY;
                        }
                    } else {
                        if (vX > 0) {
                            colDir = "l";
                            shapeA.x += oX;
                        } else {
                            colDir = "r";
                            shapeA.x -= oX;
                        }
                    }
                }
                return colDir;
            }
            
        })();
        
    </script>
    </body>
</html>
